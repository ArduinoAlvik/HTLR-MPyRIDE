<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ViperIDE P2P Bridge</title>
</head>
<body>
    <h1>ViperIDE P2P Bridge</h1>

    <button class="button" title="Connect WebREPL"       onclick="startBridge('ws')"  id="btn-conn-ws" ><i class="fa-solid fa-circle-nodes"></i></button>
    <button class="button" title="Connect Bluetooth"     onclick="startBridge('ble')" id="btn-conn-ble"><i class="fa-brands fa-bluetooth-b"></i></button>
    <button class="button" title="Connect USB/Serial"    onclick="startBridge('usb')" id="btn-conn-usb"><i class="fa-brands fa-usb"></i></button>

    <p>Bridge ID: <span id="bridge-id">none</span></p>

    <script src="https://kit.fontawesome.com/7e93d1a6ca.js" crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastr@2.1.4/toastr.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/i18next@23.11.5/i18next.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/i18next-browser-languagedetector@8.0.0/i18nextBrowserLanguageDetector.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.5.4/dist/peerjs.min.js"></script>

    <script src="./src/utils.js"></script>
    <script src="./src/transports.js"></script>
    <script>
        let port, rtc;

        async function disconnectAll() {
            document.getElementById('bridge-id').textContent = 'none'

            try {
                await rtc.disconnect()
            } catch(err) {}

            try {
                await port.disconnect()
            } catch(err) {}

            rtc = null
            port = null
        }

        const startBridge = async () => {
            try {
                await disconnectAll()

                port = new WebSerial()
                await port.requestAccess()
                await port.connect()

                rtc = new WebRTCTransport()
                await rtc.requestAccess()

                document.getElementById('bridge-id').textContent = rtc.info.id

                rtc.onReceive(async (data) => {
                    console.log('peer -> port', data)
                    await port.write(data)
                })

                port.onReceive(async (data) => {
                    console.log('port -> peer', data)
                    await rtc.write(data)
                })

                rtc.onDisconnect(() => {
                    console.log('Peer disconnected.')
                })
            } catch (err) {
                console.error('Error starting bridge:', err);
            }
        }
    </script>
</body>
</html>
